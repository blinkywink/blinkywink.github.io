<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>blinkywink.co</title>
  <link rel="shortcut icon" href="assets/images/darkicon.png" type="image/x-icon">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inconsolata:wght@400;500;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="styles.css">
</head>
<body>
  <!-- Header -->
  <header class="header">
    <div class="header-content">
      <a href="index.html" class="logo">
        <img src="assets/images/icon.png" alt="icon" class="logo-icon">
        <span class="logo-text">blinkywink.co</span>
      </a>
      <button id="change-username-btn" class="change-username-btn" style="display: none;">Change User</button>
    </div>
  </header>

  <!-- Main Content -->
  <main class="main-content">
    <!-- View Switcher -->
    <div class="stats-view-switcher">
      <button class="view-btn active" data-view="overview">Overview</button>
      <button class="view-btn" data-view="tracks">Top Tracks</button>
      <button class="view-btn" data-view="albums">Top Albums</button>
      <button class="view-btn" data-view="artists">Top Artists</button>
    </div>

    <!-- Time Period Selector -->
    <div class="time-period-selector" id="time-period-selector">
      <button class="period-btn active" data-period="overall">all</button>
      <button class="period-btn" data-period="12month">12mo</button>
      <button class="period-btn" data-period="6month">6mo</button>
      <button class="period-btn" data-period="3month">3mo</button>
      <button class="period-btn" data-period="1month">1mo</button>
    </div>

    <!-- Username Input -->
    <div id="username-input" class="username-input-container">
      <div class="username-input-box">
        <h2 class="username-title">Enter Last.fm Username</h2>
        <form id="username-form" class="username-form">
          <input type="text" id="username-field" class="username-field" placeholder="username" required>
          <button type="submit" class="username-submit">Load Stats</button>
        </form>
      </div>
    </div>

    <!-- Loading State -->
    <div id="loading" class="loading-state" style="display: none;">
      <div class="loading-spinner"></div>
      <p>Loading your stats...</p>
    </div>

    <!-- Overview View -->
    <div id="overview-view" class="stats-view active">
      <div class="stats-overview">
        <div class="stat-card">
          <div class="stat-value" id="total-scrobbles">-</div>
          <div class="stat-label">Total Plays</div>
        </div>
        <div class="stat-card">
          <div class="stat-value" id="total-artists">-</div>
          <div class="stat-label">Artists</div>
        </div>
        <div class="stat-card">
          <div class="stat-value" id="total-albums">-</div>
          <div class="stat-label">Albums</div>
        </div>
        <div class="stat-card">
          <div class="stat-value" id="total-tracks">-</div>
          <div class="stat-label">Tracks</div>
        </div>
          </div>
      <div class="now-playing-section">
        <h2 class="section-title" id="now-playing-title">Last Played</h2>
        <div id="now-playing" class="now-playing-list"></div>
      </div>

    </div>

    <!-- Top Albums View -->
    <div id="albums-view" class="stats-view">
      <h2 class="section-title">Top Albums</h2>
      <div id="top-albums" class="albums-grid"></div>
    </div>

    <!-- Top Tracks View -->
    <div id="tracks-view" class="stats-view">
      <h2 class="section-title">Top Tracks</h2>
      <div id="top-tracks" class="now-playing-list"></div>
    </div>

    <!-- Top Artists View -->
    <div id="artists-view" class="stats-view">
      <h2 class="section-title">Top Artists</h2>
      <div id="top-artists" class="artists-list"></div>
    </div>
  </main>

  <!-- Footer -->
  <footer class="footer">
    <div class="footer-content">
      <div class="footer-links">
        <a href="contact/" class="footer-link">Contact</a>
        <a href="about/" class="footer-link">About</a>
      </div>
      <div class="footer-copyright">
        © blinkywink.co
      </div>
    </div>
  </footer>

  <script>
    const LASTFM_API_KEY = '80823e348573d80af66fe59941020fa5';
    let LASTFM_USERNAME = localStorage.getItem('lastfm_username') || '';
    const API_BASE = 'https://ws.audioscrobbler.com/2.0/';

    let currentView = 'overview';
    let currentPeriod = 'overall';
    let currentPage = {
      recent: 1,
      tracks: 1,
      albums: 1,
      artists: 1
    };
    let isLoadingMore = false;

    // View switching
    document.querySelectorAll('.view-btn').forEach(btn => {
      btn.addEventListener('click', () => {
        const view = btn.dataset.view;
        switchView(view);
      });
    });

    // Period switching
    document.querySelectorAll('.period-btn').forEach(btn => {
      btn.addEventListener('click', () => {
        const period = btn.dataset.period;
        switchPeriod(period);
      });
    });

    function switchView(view) {
      currentView = view;
      document.querySelectorAll('.view-btn').forEach(btn => {
        btn.classList.toggle('active', btn.dataset.view === view);
      });
      document.querySelectorAll('.stats-view').forEach(v => {
        v.classList.toggle('active', v.id === `${view}-view`);
      });
      
      // Show time period selector for overview, albums, artists, and tracks
      const periodSelector = document.getElementById('time-period-selector');
      if (view === 'overview' || view === 'albums' || view === 'artists' || view === 'tracks') {
        periodSelector.style.display = 'flex';
      } else {
        periodSelector.style.display = 'none';
      }
      
      // Reset page counters when switching views
      currentPage = {
        recent: 1,
        tracks: 1,
        albums: 1,
        artists: 1
      };
      
      loadViewData();
    }

    function switchPeriod(period) {
      currentPeriod = period;
      document.querySelectorAll('.period-btn').forEach(btn => {
        btn.classList.toggle('active', btn.dataset.period === period);
      });
      // Reset page counters when period changes
      currentPage = {
        recent: 1,
        tracks: 1,
        albums: 1,
        artists: 1
      };
      loadViewData();
    }

    async function loadViewData() {
      showLoading();
      try {
        switch(currentView) {
          case 'overview':
            await loadOverview();
            break;
          case 'tracks':
            await loadTopTracks();
            break;
          case 'albums':
            await loadTopAlbums();
            break;
          case 'artists':
            await loadTopArtists();
            break;
        }
      } catch (error) {
        console.error('Error loading data:', error);
        showError('Failed to load data. Please try again.');
      } finally {
        hideLoading();
      }
    }

    async function fetchAPI(method, params = {}) {
      try {
        if (!LASTFM_USERNAME && method.startsWith('user.')) {
          throw new Error('No username set');
        }
        const queryParams = new URLSearchParams({
          method,
          api_key: LASTFM_API_KEY,
          format: 'json',
          ...params
        });
        // Only add user parameter for user.* methods
        if (method.startsWith('user.') && LASTFM_USERNAME) {
          queryParams.set('user', LASTFM_USERNAME);
        }
        const response = await fetch(`${API_BASE}?${queryParams}`);
        if (!response.ok) {
          throw new Error(`API request failed: ${response.status}`);
        }
        const data = await response.json();
        if (data.error) {
          throw new Error(`Last.fm API error: ${data.message || data.error}`);
        }
        return data;
      } catch (error) {
        console.error(`API error for ${method}:`, error);
        throw error;
      }
    }

    async function loadOverviewTracks(playedTracks) {
      const nowPlayingDiv = document.getElementById('now-playing');
      if (playedTracks.length > 0) {
        // Get most recent track for the title
        const mostRecent = playedTracks[0];
        let dateText = '';
        if (mostRecent.date && mostRecent.date['#text']) {
          dateText = formatDate(mostRecent.date['#text']);
        }
        
        const titleElement = document.getElementById('now-playing-title');
        titleElement.textContent = 'Last Played';
        
        const updateElement = document.getElementById('now-playing-update');
        updateElement.textContent = dateText ? `updated ${dateText}` : '';
        
        // Fetch track info to get playcounts
        const trackInfoPromises = playedTracks.map(track => 
          fetchAPI('track.getInfo', { 
            artist: track.artist['#text'] || track.artist.name, 
            track: track.name,
            username: LASTFM_USERNAME 
          }).catch(() => null)
        );
        const trackInfos = await Promise.all(trackInfoPromises);
        
        const html = playedTracks.map((track, index) => {
          const image = getImageUrl(track.image, 'extralarge');
          const artistName = track.artist['#text'] || track.artist.name || 'Unknown Artist';
          const trackName = track.name || 'Unknown Track';
          const albumName = track.album['#text'] || track.album || 'Unknown Album';
          
          // Get playcount from track info
          let playcount = 0;
          if (trackInfos[index] && trackInfos[index].track && trackInfos[index].track.userplaycount) {
            playcount = parseInt(trackInfos[index].track.userplaycount || 0);
          }
          
          return `
            <a href="${getArtistUrl(artistName)}" class="now-playing-card">
              <div class="now-playing-content">
                <img src="${image}" alt="${trackName}" class="now-playing-image" onerror="this.src='https://via.placeholder.com/100'">
                <div class="now-playing-info">
                  <div class="now-playing-track">${escapeHtml(trackName)}</div>
                  <div class="now-playing-artist">${escapeHtml(artistName)}</div>
                  <div class="now-playing-album">${escapeHtml(albumName)}</div>
                </div>
                <div class="now-playing-plays">${playcount.toLocaleString()} ${playcount === 1 ? 'play' : 'plays'}</div>
              </div>
            </a>
          `;
        }).join('');
        
        nowPlayingDiv.innerHTML = html;
      } else {
        nowPlayingDiv.innerHTML = '<div class="now-playing-placeholder">No recent tracks</div>';
      }
    }

    async function loadOverview() {
      const [userInfo, recentTracks, topArtists, topAlbums, topTracks] = await Promise.all([
        fetchAPI('user.getInfo'),
        fetchAPI('user.getRecentTracks', { limit: 3 }),
        fetchAPI('user.getTopArtists', { period: currentPeriod, limit: 1 }),
        fetchAPI('user.getTopAlbums', { period: currentPeriod, limit: 1 }),
        fetchAPI('user.getTopTracks', { period: currentPeriod, limit: 1 })
      ]);

      if (!userInfo || !userInfo.user) {
        throw new Error('Failed to load user info');
      }

      const user = userInfo.user;
      
      // Get stats from period-specific data
      let totalScrobbles = parseInt(user.playcount || 0);
      let totalArtists = parseInt(user.artist_count || 0);
      let totalAlbums = parseInt(user.album_count || 0);
      let totalTracks = parseInt(user.track_count || 0);
      
      // If period is not overall, fetch more data to get accurate counts
      if (currentPeriod !== 'overall') {
        const [fullTopArtists, fullTopAlbums, fullTopTracks] = await Promise.all([
          fetchAPI('user.getTopArtists', { period: currentPeriod, limit: 1000 }),
          fetchAPI('user.getTopAlbums', { period: currentPeriod, limit: 1000 }),
          fetchAPI('user.getTopTracks', { period: currentPeriod, limit: 1000 })
        ]);
        
        // Count unique artists
        if (fullTopArtists.topartists && fullTopArtists.topartists.artist) {
          const artists = Array.isArray(fullTopArtists.topartists.artist) 
            ? fullTopArtists.topartists.artist 
            : [fullTopArtists.topartists.artist];
          totalArtists = artists.length;
          // Sum playcounts for scrobbles
          totalScrobbles = artists.reduce((sum, a) => sum + parseInt(a.playcount || 0), 0);
        }
        
        // Count unique albums
        if (fullTopAlbums.topalbums && fullTopAlbums.topalbums.album) {
          const albums = Array.isArray(fullTopAlbums.topalbums.album) 
            ? fullTopAlbums.topalbums.album 
            : [fullTopAlbums.topalbums.album];
          totalAlbums = albums.length;
        }
        
        // Count unique tracks
        if (fullTopTracks.toptracks && fullTopTracks.toptracks.track) {
          const tracks = Array.isArray(fullTopTracks.toptracks.track) 
            ? fullTopTracks.toptracks.track 
            : [fullTopTracks.toptracks.track];
          totalTracks = tracks.length;
        }
      }
      
      document.getElementById('total-scrobbles').textContent = totalScrobbles.toLocaleString();
      document.getElementById('total-artists').textContent = totalArtists.toLocaleString();
      document.getElementById('total-albums').textContent = totalAlbums.toLocaleString();
      document.getElementById('total-tracks').textContent = totalTracks.toLocaleString();

      // Show last played tracks
      if (recentTracks.recenttracks && recentTracks.recenttracks.track) {
        const tracks = Array.isArray(recentTracks.recenttracks.track) 
          ? recentTracks.recenttracks.track 
          : [recentTracks.recenttracks.track];
        
        // Filter out now playing tracks
        const playedTracks = tracks.filter(t => !t['@attr'] || !t['@attr'].nowplaying);
        await loadOverviewTracks(playedTracks);
      } else {
        const nowPlayingDiv = document.getElementById('now-playing');
        nowPlayingDiv.innerHTML = '<div class="now-playing-placeholder">No recent tracks</div>';
      }
    }

    async function loadRecentTracks(page = 1, append = false) {
      const limit = 50;
      const data = await fetchAPI('user.getRecentTracks', { limit: limit, page: page });
      const tracks = data.recenttracks.track;
      const tracksList = document.getElementById('recent-tracks');
      
      if (!tracks || tracks.length === 0) {
        if (!append) {
          tracksList.innerHTML = '<div class="empty-state">No recent tracks found</div>';
        }
        return;
      }

      const trackArray = Array.isArray(tracks) ? tracks : [tracks];
      const html = trackArray.map(track => {
        const image = getImageUrl(track.image, 'extralarge');
        const isNowPlaying = track['@attr'] && track['@attr'].nowplaying === 'true';
        const dateText = isNowPlaying ? 'Now playing' : (track.date && track.date['#text'] ? formatDate(track.date['#text']) : '');
        const artistName = track.artist['#text'] || track.artist.name || 'Unknown Artist';
        const trackName = track.name || 'Unknown Track';
        const albumName = track.album['#text'] || track.album || 'Unknown Album';
        
        return `
          <a href="${getTrackUrl(artistName, trackName)}" class="track-item-link">
            <div class="track-item ${isNowPlaying ? 'now-playing-track' : ''}">
              <img src="${image}" alt="${trackName}" class="track-image" onerror="this.src='https://via.placeholder.com/80'">
              <div class="track-info">
                <div class="track-name">${escapeHtml(trackName)}</div>
                <div class="track-artist">${escapeHtml(artistName)}</div>
                <div class="track-album">${escapeHtml(albumName)}</div>
              </div>
              <div class="track-meta">
                ${isNowPlaying ? '<span class="now-playing-badge">▶</span>' : ''}
                <div class="track-date">${dateText}</div>
              </div>
            </div>
          </a>
        `;
      }).join('');
      
      if (append) {
        tracksList.innerHTML += html;
      } else {
        tracksList.innerHTML = html;
      }
      
      currentPage.recent = page;
    }

    async function loadTopTracks(page = 1, append = false) {
      const limit = 50;
      const data = await fetchAPI('user.getTopTracks', { period: currentPeriod, limit: limit, page: page });
      const tracks = data.toptracks.track;
      const tracksList = document.getElementById('top-tracks');
      
      if (!tracks || tracks.length === 0) {
        if (!append) {
          tracksList.innerHTML = '<div class="empty-state">No tracks found</div>';
        }
        return;
      }

      const trackArray = Array.isArray(tracks) ? tracks : [tracks];
      
      // Fetch track info to get album images
      const trackInfoPromises = trackArray.map(track => 
        fetchAPI('track.getInfo', { 
          artist: track.artist.name, 
          track: track.name,
          username: LASTFM_USERNAME 
        }).catch(() => null)
      );
      const trackInfos = await Promise.all(trackInfoPromises);
      
      const html = trackArray.map((track, index) => {
        let image = 'https://via.placeholder.com/80';
        let albumName = 'Unknown Album';
        // Try to get album image and name from track info
        if (trackInfos[index] && trackInfos[index].track && trackInfos[index].track.album) {
          const album = trackInfos[index].track.album;
          albumName = album.title || 'Unknown Album';
          const albumImage = album.image;
          if (albumImage && albumImage.length > 0) {
            image = getImageUrl(albumImage, 'extralarge');
          }
        }
        // Fallback to track.image if available
        if (!image || image.includes('placeholder')) {
          const trackImg = getImageUrl(track.image, 'extralarge');
          if (trackImg && !trackImg.includes('placeholder')) {
            image = trackImg;
          }
        }
        
        const artistName = track.artist.name || 'Unknown Artist';
        const trackName = track.name || 'Unknown Track';
        const playcount = parseInt(track.playcount || 0);
        
        return `
          <a href="${getTrackUrl(artistName, trackName)}" class="now-playing-card">
            <div class="now-playing-content">
              <img src="${image}" alt="${trackName}" class="now-playing-image" onerror="this.src='https://via.placeholder.com/100'">
              <div class="now-playing-info">
                <div class="now-playing-track">${escapeHtml(trackName)}</div>
                <div class="now-playing-artist">${escapeHtml(artistName)}</div>
                <div class="now-playing-album">${escapeHtml(albumName)}</div>
              </div>
              <div class="now-playing-plays">${playcount.toLocaleString()} ${playcount === 1 ? 'play' : 'plays'}</div>
            </div>
          </a>
        `;
      }).join('');
      
      if (append) {
        tracksList.innerHTML += html;
      } else {
        tracksList.innerHTML = html;
      }
      
      currentPage.tracks = page;
    }

    async function loadTopAlbums(page = 1, append = false) {
      const limit = 50;
      const data = await fetchAPI('user.getTopAlbums', { period: currentPeriod, limit: limit, page: page });
      const albums = data.topalbums.album;
      const albumsGrid = document.getElementById('top-albums');
      
      if (!albums || albums.length === 0) {
        if (!append) {
          albumsGrid.innerHTML = '<div class="empty-state">No albums found</div>';
        }
        return;
      }

      const albumArray = Array.isArray(albums) ? albums : [albums];
      const html = albumArray.map(album => {
        const image = getImageUrl(album.image, 'extralarge');
        const albumName = album.name || 'Unknown Album';
        const artistName = album.artist.name || 'Unknown Artist';
        
        return `
          <a href="${getAlbumUrl(artistName, albumName)}" class="album-card-link">
            <div class="album-card">
              <img src="${image}" alt="${albumName}" class="album-cover" onerror="this.src='https://via.placeholder.com/300'">
              <div class="album-info">
                <div class="album-name">${escapeHtml(albumName)}</div>
                <div class="album-artist">${escapeHtml(artistName)}</div>
                <div class="album-plays">${parseInt(album.playcount || 0).toLocaleString()} plays</div>
              </div>
            </div>
          </a>
        `;
      }).join('');
      
      if (append) {
        albumsGrid.innerHTML += html;
      } else {
        albumsGrid.innerHTML = html;
      }
      
      currentPage.albums = page;
    }

    async function loadTopArtists(page = 1, append = false) {
      const limit = 50;
      const data = await fetchAPI('user.getTopArtists', { period: currentPeriod, limit: limit, page: page });
      const artists = data.topartists.artist;
      const artistsList = document.getElementById('top-artists');
      
      if (!artists || artists.length === 0) {
        if (!append) {
          artistsList.innerHTML = '<div class="empty-state">No artists found</div>';
        }
        return;
      }

      const artistArray = Array.isArray(artists) ? artists : [artists];
      
      // Fetch artist info for images
      const artistPromises = artistArray.map(artist => 
        fetchAPI('artist.getInfo', { artist: artist.name }).catch(() => null)
      );
      const artistInfos = await Promise.all(artistPromises);
      
      const html = artistArray.map((artist, index) => {
        const artistName = artist.name || 'Unknown Artist';
        // Try to get image from artist info
        let image = 'https://via.placeholder.com/100';
        if (artistInfos[index] && artistInfos[index].artist && artistInfos[index].artist.image) {
          const artistImg = getImageUrl(artistInfos[index].artist.image, 'extralarge');
          if (artistImg && !artistImg.includes('placeholder')) {
            image = artistImg;
          }
        }
        
        return `
          <a href="${getArtistUrl(artistName)}" class="artist-item-link">
            <div class="artist-item">
              <div class="artist-rank">#${index + 1}</div>
              <img src="${image}" alt="${artistName}" class="artist-image" onerror="this.src='https://via.placeholder.com/100'">
              <div class="artist-info">
                <div class="artist-name">${escapeHtml(artistName)}</div>
                <div class="artist-plays">${parseInt(artist.playcount || 0).toLocaleString()} plays</div>
              </div>
            </div>
          </a>
        `;
      }).join('');
      
      if (append) {
        artistsList.innerHTML += html;
      } else {
        artistsList.innerHTML = html;
      }
      
      currentPage.artists = page;
    }

    function showLoading() {
      document.getElementById('loading').style.display = 'flex';
    }

    function hideLoading() {
      document.getElementById('loading').style.display = 'none';
    }

    function showError(message) {
      const views = document.querySelectorAll('.stats-view');
      views.forEach(view => {
        if (view.classList.contains('active')) {
          view.innerHTML = `<div class="error-state">${message}</div>`;
        }
      });
    }

    function escapeHtml(text) {
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }

    function formatDate(dateString) {
      if (!dateString) return '';
      
      // Last.fm returns dates in format like "1 Jan 2024, 12:34" or Unix timestamp
      let date;
      if (typeof dateString === 'number' || /^\d+$/.test(dateString)) {
        // Unix timestamp
        date = new Date(parseInt(dateString) * 1000);
      } else {
        // Try parsing as date string
        date = new Date(dateString);
      }
      
      // Check if date is valid
      if (isNaN(date.getTime())) {
        return dateString; // Return original string if parsing failed
      }
      
      const now = new Date();
      const diffMs = now - date;
      
      // If negative difference, the date is in the future (shouldn't happen but handle it)
      if (diffMs < 0) {
        return date.toLocaleDateString();
      }
      
      const diffMins = Math.floor(diffMs / 60000);
      const diffHours = Math.floor(diffMs / 3600000);
      const diffDays = Math.floor(diffMs / 86400000);

      const diffWeeks = Math.floor(diffDays / 7);
      const diffMonths = Math.floor(diffDays / 30);

      if (diffMins < 1) return 'moments ago';
      if (diffMins < 60) return `${diffMins} ${diffMins === 1 ? 'minute' : 'minutes'} ago`;
      if (diffHours < 24) return `${diffHours} ${diffHours === 1 ? 'hour' : 'hours'} ago`;
      if (diffDays < 7) return `${diffDays} ${diffDays === 1 ? 'day' : 'days'} ago`;
      if (diffWeeks < 4) return `${diffWeeks} ${diffWeeks === 1 ? 'week' : 'weeks'} ago`;
      if (diffMonths < 12) return `${diffMonths} ${diffMonths === 1 ? 'month' : 'months'} ago`;
      return date.toLocaleDateString();
    }

    function getImageUrl(imageArray, size = 'large') {
      if (!imageArray || !Array.isArray(imageArray) || imageArray.length === 0) {
        return 'https://via.placeholder.com/300';
      }
      
      // Last.fm image sizes: [small, medium, large, extralarge, mega]
      // size can be: 'small' (34x34), 'medium' (64x64), 'large' (174x174), 'extralarge' (300x300), 'mega' (600x600)
      let imageIndex = 2; // default to large
      if (size === 'small') imageIndex = 0;
      else if (size === 'medium') imageIndex = 1;
      else if (size === 'large') imageIndex = 2;
      else if (size === 'extralarge') imageIndex = 3;
      else if (size === 'mega') imageIndex = 4;
      
      // Use the requested size, or fall back to largest available
      const image = imageArray[Math.min(imageIndex, imageArray.length - 1)] || imageArray[imageArray.length - 1];
      const url = image && image['#text'] ? image['#text'] : '';
      // Last.fm sometimes returns empty strings, use placeholder if empty
      return url && url.trim() !== '' ? url : 'https://via.placeholder.com/300';
    }

    function getArtistUrl(artistName) {
      return `artist/?artist=${encodeURIComponent(artistName)}`;
    }

    function getAlbumUrl(artistName, albumName) {
      // Redirect to artist page instead of album page
      return `artist/?artist=${encodeURIComponent(artistName)}`;
    }

    function getTrackUrl(artistName, trackName) {
      // Redirect to artist page instead of track page
      return `artist/?artist=${encodeURIComponent(artistName)}`;
    }

    // Register service worker for image caching
    if ('serviceWorker' in navigator) {
      window.addEventListener('load', () => {
        navigator.serviceWorker.register('/service-worker.js')
          .then((registration) => {
            console.log('Service Worker registered:', registration.scope);
          })
          .catch((error) => {
            console.log('Service Worker registration failed:', error);
          });
      });
    }

    // Infinite scroll handler
    function setupInfiniteScroll() {
      window.addEventListener('scroll', () => {
        if (isLoadingMore) return;
        
        const scrollTop = window.pageYOffset || document.documentElement.scrollTop;
        const windowHeight = window.innerHeight;
        const documentHeight = document.documentElement.scrollHeight;
        
        // Load more when 200px from bottom
        if (scrollTop + windowHeight >= documentHeight - 200) {
          isLoadingMore = true;
          
          if (currentView === 'overview') {
            // Load more recent tracks for overview
            const currentCount = document.querySelectorAll('.now-playing-card').length;
            fetchAPI('user.getRecentTracks', { limit: currentCount + 10 })
              .then(data => {
                if (data.recenttracks && data.recenttracks.track) {
                  const tracks = Array.isArray(data.recenttracks.track) 
                    ? data.recenttracks.track 
                    : [data.recenttracks.track];
                  const playedTracks = tracks.filter(t => !t['@attr'] || !t['@attr'].nowplaying);
                  const nowPlayingDiv = document.getElementById('now-playing');
                  const existingHtml = nowPlayingDiv.innerHTML;
                  const newTracks = playedTracks.slice(currentCount);
                  // Fetch track info for playcounts
                  const trackInfoPromises = newTracks.map(track => 
                    fetchAPI('track.getInfo', { 
                      artist: track.artist['#text'] || track.artist.name, 
                      track: track.name,
                      username: LASTFM_USERNAME 
                    }).catch(() => null)
                  );
                  Promise.all(trackInfoPromises).then(trackInfos => {
                    const newHtml = newTracks.map((track, index) => {
                      const image = getImageUrl(track.image, 'extralarge');
                      const artistName = track.artist['#text'] || track.artist.name || 'Unknown Artist';
                      const trackName = track.name || 'Unknown Track';
                      const albumName = track.album['#text'] || track.album || 'Unknown Album';
                      
                      let playcount = 0;
                      if (trackInfos[index] && trackInfos[index].track && trackInfos[index].track.userplaycount) {
                        playcount = parseInt(trackInfos[index].track.userplaycount || 0);
                      }
                      
                      return `
                        <a href="${getArtistUrl(artistName)}" class="now-playing-card">
                          <div class="now-playing-content">
                            <img src="${image}" alt="${trackName}" class="now-playing-image" onerror="this.src='https://via.placeholder.com/100'">
                            <div class="now-playing-info">
                              <div class="now-playing-track">${escapeHtml(trackName)}</div>
                              <div class="now-playing-artist">${escapeHtml(artistName)}</div>
                              <div class="now-playing-album">${escapeHtml(albumName)}</div>
                            </div>
                            <div class="now-playing-plays">${playcount.toLocaleString()} ${playcount === 1 ? 'play' : 'plays'}</div>
                          </div>
                        </a>
                      `;
                    }).join('');
                    nowPlayingDiv.innerHTML = existingHtml + newHtml;
                  });
                }
              })
              .finally(() => {
                isLoadingMore = false;
              });
          } else if (currentView === 'tracks') {
            loadTopTracks(currentPage.tracks + 1, true).finally(() => {
              isLoadingMore = false;
            });
          } else if (currentView === 'albums') {
            loadTopAlbums(currentPage.albums + 1, true).finally(() => {
              isLoadingMore = false;
            });
          } else if (currentView === 'artists') {
            loadTopArtists(currentPage.artists + 1, true).finally(() => {
              isLoadingMore = false;
            });
          }
        }
      });
    }

    // Username form handler
    document.getElementById('username-form').addEventListener('submit', (e) => {
      e.preventDefault();
      const username = document.getElementById('username-field').value.trim();
      if (username) {
        LASTFM_USERNAME = username;
        localStorage.setItem('lastfm_username', username);
        document.getElementById('username-input').style.display = 'none';
        document.getElementById('change-username-btn').style.display = 'block';
        // Show all views
        document.querySelectorAll('.stats-view').forEach(v => v.style.display = '');
        document.querySelector('.stats-view-switcher').style.display = 'flex';
        loadViewData();
        setupInfiniteScroll();
      }
    });

    // Initial load
    document.addEventListener('DOMContentLoaded', () => {
      if (LASTFM_USERNAME) {
        document.getElementById('username-input').style.display = 'none';
        document.getElementById('change-username-btn').style.display = 'block';
        loadViewData();
        setupInfiniteScroll();
      } else {
        document.getElementById('username-input').style.display = 'flex';
        document.getElementById('change-username-btn').style.display = 'none';
        // Hide all views until username is entered
        document.querySelectorAll('.stats-view').forEach(v => v.style.display = 'none');
        document.querySelector('.stats-view-switcher').style.display = 'none';
        document.getElementById('time-period-selector').style.display = 'none';
      }
    });
  </script>

</body>
</html> 
